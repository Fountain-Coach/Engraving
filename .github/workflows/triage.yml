name: CI Failure Triage

on:
  workflow_run:
    workflows: ["Engraving CI", "RulesKit Swift Build"]
    types: [completed]

jobs:
  open-issue-on-failure:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Open issue for failed run
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const title = `[CI Failure] ${run.name} #${run.run_number} on ${run.head_branch}`;
            const body = `Workflow: ${run.name}\nRun: ${run.html_url}\nBranch: ${run.head_branch}\nCommit: ${run.head_sha}\nConclusion: ${run.conclusion}\nEvent: ${run.event}\nActor: ${run.triggering_actor && run.triggering_actor.login ? run.triggering_actor.login : 'unknown'}`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['ci-failure']
            });
